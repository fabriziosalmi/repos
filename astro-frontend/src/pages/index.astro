---
import Layout from '../layouts/Layout.astro';
import HeroSection from '../components/HeroSection.astro';
import ContentRow from '../components/ContentRow.astro';
import SearchBar from '../components/SearchBar.astro';
import StatsBar from '../components/StatsBar.astro';
import repositories from '../data/repositories.json';

// Type helper
interface Repo { [key: string]: any; }
const repos: Repo[] = repositories as Repo[];

// Calculate stats
const totalRepos = repos.length;
const totalStars = repos.reduce((acc, r) => acc + (r.stars || 0), 0);
const totalForks = repos.reduce((acc, r) => acc + (r.forks || 0), 0);
const activeRepos = repos.filter(r => (r.status || '').includes('ACTIVE')).length;

// Sort helpers
const byStars = (a: Repo, b: Repo) => (b.stars || 0) - (a.stars || 0);
const byForks = (a: Repo, b: Repo) => (b.forks || 0) - (a.forks || 0);
const byDate = (field: string) => (a: Repo, b: Repo) => {
    const da = a[field] ? new Date(a[field]).getTime() : 0;
    const db = b[field] ? new Date(b[field]).getTime() : 0;
    return db - da;
};

// Hero: top repo by stars
const heroRepo = [...repos].sort(byStars)[0];
const allExceptHero = repos.filter(r => r.name !== heroRepo?.name);

// Trending: repos with growing momentum or fire status
const trending = repos.filter(r =>
    (r.status || '').includes('ðŸ”¥') ||
    r.momentum?.trend === 'growing'
).sort(byStars);

// Most starred (excluding hero)
const mostStarred = [...allExceptHero].sort(byStars).slice(0, 15);

// Recently updated
const recentlyUpdated = [...repos].sort(byDate('last_update_api')).slice(0, 15);

// New arrivals
const newArrivals = [...repos].sort(byDate('created_at_api')).slice(0, 15);

// Community favorites (by forks)
const communityFavorites = [...repos].sort(byForks).slice(0, 15);

// Language rows: only languages with 3+ repos
const langGroups: Record<string, Repo[]> = {};
for (const r of repos) {
    const lang = r.language || null;
    if (!lang) continue;
    if (!langGroups[lang]) langGroups[lang] = [];
    langGroups[lang].push(r);
}
const languageRows = Object.entries(langGroups)
    .filter(([_, arr]) => arr.length >= 3)
    .sort((a, b) => b[1].length - a[1].length)
    .map(([lang, arr]) => ({
        title: `${lang} Projects`,
        id: `lang-${lang.toLowerCase().replace(/[^a-z0-9]/g, '')}`,
        repos: arr.sort(byStars).slice(0, 20),
    }));

// All content rows
const rows = [
    ...(trending.length >= 2 ? [{ title: 'Trending', id: 'trending', repos: trending }] : []),
    { title: 'Most Starred', id: 'most-starred', repos: mostStarred },
    { title: 'Recently Updated', id: 'recently-updated', repos: recentlyUpdated },
    { title: 'New Arrivals', id: 'new-arrivals', repos: newArrivals },
    { title: 'Community Favorites', id: 'community', repos: communityFavorites },
    ...languageRows,
].filter(row => row.repos.length >= 2);
---

<Layout title="Fabrizio Salmi | GitHub Repositories">
    <main class="min-h-screen bg-background relative">
        <!-- Sticky search/nav bar -->
        <SearchBar totalRepos={totalRepos} totalStars={totalStars} totalForks={totalForks} />

        <!-- Hero section -->
        {heroRepo && (
            <div id="hero-section">
                <HeroSection repo={heroRepo} />
            </div>
        )}

        <!-- Stats bar -->
        <div id="stats-bar">
            <StatsBar
                totalRepos={totalRepos}
                totalStars={totalStars}
                totalForks={totalForks}
                activeRepos={activeRepos}
            />
        </div>

        <!-- Content rows -->
        <div id="rows-container" class="py-6">
            {rows.map(row => (
                <ContentRow title={row.title} repos={row.repos} id={row.id} />
            ))}
        </div>

        <!-- Footer -->
        <footer class="text-center text-textMuted text-sm py-10 border-t border-white/5">
            <p>Updated daily via GitHub Actions &middot; {new Date().toLocaleDateString()}</p>
        </footer>
    </main>
</Layout>
