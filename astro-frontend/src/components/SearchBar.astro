---
import { Github, Search, Code2, Star, GitFork } from "lucide-react";

interface Props {
    totalRepos: number;
    totalStars: number;
    totalForks: number;
}

const { totalRepos, totalStars, totalForks } = Astro.props;
---

<div
    id="search-bar"
    class="sticky top-0 z-50 bg-background/60 backdrop-blur-2xl border-b border-white/5 transition-all duration-500"
>
    <div
        class="max-w-[1800px] mx-auto px-6 md:px-12 py-4 flex items-center justify-between gap-8"
    >
        <!-- Left: Brand -->
        <div class="flex items-center gap-3 flex-shrink-0 group cursor-pointer">
            <div
                class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center border border-primary/20 group-hover:scale-110 transition-transform"
            >
                <Github size={22} className="text-primary" />
            </div>
            <div class="flex flex-col hidden sm:flex">
                <span
                    class="text-sm font-black text-white leading-tight uppercase tracking-tighter"
                    >fabriziosalmi</span
                >
                <span
                    class="text-[10px] font-bold text-primary tracking-widest uppercase"
                    >Portfolio</span
                >
            </div>
        </div>

        <!-- Center: Search -->
        <div class="relative flex-1 max-w-xl group">
            <div
                class="absolute inset-0 bg-primary/20 rounded-2xl blur-xl opacity-0 group-focus-within:opacity-100 transition-opacity"
            >
            </div>
            <div class="relative">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search the collection..."
                    class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 px-6 pl-12 text-sm text-white placeholder-textMuted focus:outline-none focus:border-primary/50 focus:bg-white/10 transition-all shadow-premium"
                />
                <Search
                    className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-textMuted group-focus-within:text-primary transition-colors pointer-events-none"
                />
                <kbd
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] font-bold text-textMuted bg-white/5 border border-white/10 px-2 py-1 rounded-lg hidden md:inline font-mono tracking-widest"
                    >/</kbd
                >
            </div>
        </div>

        <!-- Right: Stats summary -->
        <div
            class="hidden xl:flex items-center gap-6 text-[11px] font-bold text-textMuted flex-shrink-0"
        >
            <div
                class="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"
            >
                <Code2 size={14} className="text-primary" />
                <span class="text-white">{totalRepos}</span>
                <span class="uppercase tracking-widest opacity-50">Repos</span>
            </div>
            <div
                class="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"
            >
                <Star size={14} className="text-yellow-500 fill-yellow-500" />
                <span class="text-white">{totalStars.toLocaleString()}</span>
                <span class="uppercase tracking-widest opacity-50">Stars</span>
            </div>
            <div
                class="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"
            >
                <GitFork size={14} className="text-secondary" />
                <span class="text-white">{totalForks.toLocaleString()}</span>
                <span class="uppercase tracking-widest opacity-50">Forks</span>
            </div>
        </div>
    </div>
</div>

<!-- Search no-results message -->
<div
    id="search-no-results"
    class="hidden text-center py-32 px-8 animate-fade-in"
>
    <div
        class="w-24 h-24 bg-surfaceHighlight rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-premium border border-white/5"
    >
        <Search className="w-10 h-10 text-textMuted opacity-20" />
    </div>
    <p class="text-2xl font-bold text-white font-display">No matches found</p>
    <p class="text-textMuted mt-2 max-w-sm mx-auto font-medium">
        Try searching for a different language, repository name or descriptive
        keyword.
    </p>
</div>

<script>
    const searchInput = document.getElementById(
        "search-input",
    ) as HTMLInputElement;
    const heroSection = document.getElementById("hero-section");
    const statsBar = document.getElementById("stats-bar");
    const noResults = document.getElementById("search-no-results");
    const searchBar = document.getElementById("search-bar");

    // Keyboard shortcut: "/" to focus search
    document.addEventListener("keydown", (e) => {
        if (e.key === "/" && document.activeElement !== searchInput) {
            e.preventDefault();
            searchInput?.focus();
        }
        if (e.key === "Escape" && document.activeElement === searchInput) {
            searchInput.value = "";
            searchInput.blur();
            filterRepos("");
        }
    });

    let debounceTimer: any;
    searchInput?.addEventListener("input", (e) => {
        const target = e.target as HTMLInputElement;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => filterRepos(target.value), 150);
    });

    function filterRepos(query: string) {
        const q = query.toLowerCase().trim();

        if (!q) {
            document
                .querySelectorAll(".row-card")
                .forEach((card) => ((card as HTMLElement).style.display = ""));
            document
                .querySelectorAll('[id^="row-"]')
                .forEach(
                    (section) => ((section as HTMLElement).style.display = ""),
                );
            if (heroSection) heroSection.style.display = "";
            if (statsBar) statsBar.style.display = "";
            if (noResults) noResults.classList.add("hidden");
            return;
        }

        if (heroSection) heroSection.style.display = "none";
        if (statsBar) statsBar.style.display = "none";

        let totalVisible = 0;
        document.querySelectorAll(".row-card").forEach((card) => {
            const name = (
                card.getAttribute("data-repo-name") || ""
            ).toLowerCase();
            const lang = (
                card.getAttribute("data-repo-lang") || ""
            ).toLowerCase();
            const desc = (
                card.getAttribute("data-repo-desc") || ""
            ).toLowerCase();
            const match =
                name.includes(q) || lang.includes(q) || desc.includes(q);
            (card as HTMLElement).style.display = match ? "" : "none";
            if (match) totalVisible++;
        });

        document.querySelectorAll('[id^="row-"]').forEach((section) => {
            const visibleCards = section.querySelectorAll(
                '.row-card:not([style*="display: none"])',
            );
            (section as HTMLElement).style.display =
                visibleCards.length === 0 ? "none" : "";
        });

        if (noResults) noResults.classList.toggle("hidden", totalVisible > 0);
    }

    window.addEventListener(
        "scroll",
        () => {
            if (window.scrollY > 20) {
                searchBar?.classList.add(
                    "py-2",
                    "bg-background/80",
                    "border-primary/10",
                );
                searchBar?.classList.remove("py-4");
            } else {
                searchBar?.classList.remove(
                    "py-2",
                    "bg-background/80",
                    "border-primary/10",
                );
                searchBar?.classList.add("py-4");
            }
        },
        { passive: true },
    );
</script>
