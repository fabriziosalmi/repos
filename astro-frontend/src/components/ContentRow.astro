---
import { ChevronLeft, ChevronRight } from "lucide-react";
import RowCard from "./RowCard.astro";

interface Props {
    title: string;
    repos: any[];
    id: string;
}

const { title, repos, id } = Astro.props;
---

<section class="mb-12 relative group/row" id={`row-${id}`}>
    <!-- Row title -->
    <div class="px-6 md:px-12 mb-6 flex items-baseline justify-between">
        <h2
            class="text-xl md:text-3xl font-bold text-white font-display tracking-tight flex items-center gap-3"
        >
            {title}
            <span
                class="text-xs md:text-sm font-medium px-2 py-0.5 rounded-full bg-white/5 border border-white/10 text-textMuted font-sans"
            >
                {repos.length}
            </span>
        </h2>
        <div
            class="h-px flex-1 mx-8 bg-gradient-to-r from-white/10 to-transparent hidden md:block"
        >
        </div>
    </div>

    <!-- Scroll container wrapper -->
    <div class="relative px-0">
        <!-- Left arrow -->
        <button
            class="scroll-arrow absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 z-40
                   bg-surface/80 backdrop-blur-xl border border-white/10 rounded-full
                   text-white shadow-premium opacity-0 group-hover/row:opacity-100
                   transition-all duration-300 hover:scale-110 hover:bg-surface hover:border-primary/50
                   flex items-center justify-center cursor-pointer hidden md:flex"
            data-direction="left"
            data-target={`scroll-${id}`}
            aria-label="Scroll left"
        >
            <ChevronLeft size={24} />
        </button>

        <!-- Scrollable row -->
        <div
            class="scroll-row flex gap-4 md:gap-8 px-6 md:px-12 pb-8 pt-2 scroll-smooth overflow-x-auto overflow-y-visible"
            id={`scroll-${id}`}
        >
            {repos.map((repo, i) => <RowCard repo={repo} index={i} />)}
            <!-- Spacer for end of row -->
            <div class="flex-shrink-0 w-6 md:w-12 h-full"></div>
        </div>

        <!-- Right arrow -->
        <button
            class="scroll-arrow absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 z-40
                   bg-surface/80 backdrop-blur-xl border border-white/10 rounded-full
                   text-white shadow-premium opacity-0 group-hover/row:opacity-100
                   transition-all duration-300 hover:scale-110 hover:bg-surface hover:border-primary/50
                   flex items-center justify-center cursor-pointer hidden md:flex"
            data-direction="right"
            data-target={`scroll-${id}`}
            aria-label="Scroll right"
        >
            <ChevronRight size={24} />
        </button>
    </div>
</section>

<script>
    function initScrollRow(row: HTMLElement) {
        const id = row.id;
        const leftBtn = document.querySelector(
            `[data-target="${id}"][data-direction="left"]`,
        );
        const rightBtn = document.querySelector(
            `[data-target="${id}"][data-direction="right"]`,
        );

        const updateArrows = () => {
            if (leftBtn) {
                const isAtStart = row.scrollLeft <= 10;
                (leftBtn as HTMLElement).style.opacity = isAtStart ? "0" : "1";
                (leftBtn as HTMLElement).style.pointerEvents = isAtStart
                    ? "none"
                    : "auto";
            }
            if (rightBtn) {
                const isAtEnd =
                    row.scrollLeft >= row.scrollWidth - row.clientWidth - 10;
                (rightBtn as HTMLElement).style.opacity = isAtEnd ? "0" : "1";
                (rightBtn as HTMLElement).style.pointerEvents = isAtEnd
                    ? "none"
                    : "auto";
            }
        };

        row.addEventListener("scroll", updateArrows, { passive: true });
        window.addEventListener("resize", updateArrows, { passive: true });

        // Buttons click
        leftBtn?.addEventListener("click", () => {
            row.scrollBy({ left: -row.clientWidth * 0.8, behavior: "smooth" });
        });
        rightBtn?.addEventListener("click", () => {
            row.scrollBy({ left: row.clientWidth * 0.8, behavior: "smooth" });
        });

        // Initial check
        setTimeout(updateArrows, 100);
    }

    // Initialize all rows
    document.querySelectorAll(".scroll-row").forEach((row) => {
        initScrollRow(row as HTMLElement);
    });

    // Handle view transitions if any
    document.addEventListener("astro:page-load", () => {
        document.querySelectorAll(".scroll-row").forEach((row) => {
            initScrollRow(row as HTMLElement);
        });
    });
</script>
